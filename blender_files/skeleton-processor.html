<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skeleton Processor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #1a1a2e;
            color: white;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #4CAF50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .status {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            min-height: 60px;
        }
        
        .viewer {
            width: 100%;
            height: 400px;
            border: 2px solid #333;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .file-input {
            margin: 20px 0;
            text-align: center;
        }
        
        .file-input input[type="file"] {
            display: none;
        }
        
        .file-input label {
            background: #2196F3;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: inline-block;
        }
        
        .file-input label:hover {
            background: #1976D2;
        }
        
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .result-panel {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        
        .mesh-item {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            font-family: monospace;
        }
        
        .mesh-item.renamed {
            color: #4CAF50;
        }
        
        .mesh-item.unchanged {
            color: #ffd93d;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü¶¥ Skeleton Processor</h1>
        
        <div class="panel">
            <h3>üìã Processing Rules</h3>
            <ul>
                <li><strong>.r.001</strong> ‚Üí <strong>.l</strong> (removes .001 suffix)</li>
                <li><strong>_right.001</strong> ‚Üí <strong>_left</strong> (removes .001 suffix)</li>
                <li>All other meshes remain unchanged</li>
                <li>Processes any GLB file for future use</li>
            </ul>
        </div>
        
        <div class="file-input">
            <label for="file-input">üìÅ Select GLB File</label>
            <input type="file" id="file-input" accept=".glb" />
        </div>
        
        <div class="controls">
            <button onclick="processFile()" id="process-btn" disabled>üîÑ Process Skeleton</button>
            <button onclick="downloadProcessed()" id="download-btn" disabled>üíæ Download Processed GLB</button>
            <button onclick="resetView()">üéØ Reset View</button>
        </div>
        
        <div class="progress" id="progress" style="display: none;">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        
        <div class="status" id="status">
            Select a GLB file to begin processing...
        </div>
        
        <div class="viewer" id="viewer"></div>
        
        <div class="results" id="results" style="display: none;">
            <div class="result-panel">
                <h3>üìä Processing Summary</h3>
                <div id="summary">No data yet...</div>
            </div>
            <div class="result-panel">
                <h3>üîÑ Renamed Meshes</h3>
                <div id="renamed-list">No renames yet...</div>
            </div>
            <div class="result-panel">
                <h3>üìã All Meshes</h3>
                <div id="all-meshes">No meshes yet...</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/exporters/GLTFExporter.js"></script>

    <script>
        // Global variables
        let scene, camera, renderer, controls;
        let originalSkeleton = null;
        let processedSkeleton = null;
        let processingResults = {
            total: 0,
            renamed: [],
            unchanged: [],
            allMeshes: []
        };

        // Initialize the 3D viewer
        function init() {
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);
            
            // Create camera
            camera = new THREE.PerspectiveCamera(75, 1200 / 400, 0.1, 1000);
            camera.position.set(5, 5, 5);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(1200, 400);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('viewer').appendChild(renderer.domElement);
            
            // Add lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // Add controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // File input handler
            document.getElementById('file-input').addEventListener('change', handleFileSelect);
            
            // Start animation
            animate();
        }

        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.name.endsWith('.glb')) {
                document.getElementById('process-btn').disabled = false;
                updateStatus(`File selected: ${file.name}`);
            } else {
                updateStatus('Please select a valid GLB file');
            }
        }

        // Process the selected file
        async function processFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                updateStatus('Please select a file first');
                return;
            }
            
            document.getElementById('process-btn').disabled = true;
            document.getElementById('progress').style.display = 'block';
            
            try {
                await loadAndProcessFile(file);
                updateStatus('‚úÖ Processing completed successfully!');
                document.getElementById('download-btn').disabled = false;
                document.getElementById('results').style.display = 'grid';
            } catch (error) {
                updateStatus('‚ùå Error: ' + error.message);
                document.getElementById('process-btn').disabled = false;
            }
        }

        // Load and process the GLB file
        function loadAndProcessFile(file) {
            return new Promise((resolve, reject) => {
                updateStatus('Loading GLB file...');
                updateProgress(10);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    
                    const loader = new THREE.GLTFLoader();
                    loader.parse(arrayBuffer, '', function(gltf) {
                        console.log('GLB file loaded successfully!');
                        originalSkeleton = gltf.scene;
                        
                        // Process the skeleton
                        processSkeleton(originalSkeleton);
                        
                        // Add to scene
                        scene.add(originalSkeleton);
                        centerSkeleton();
                        
                        updateStatus('Skeleton processed and loaded!');
                        updateProgress(100);
                        resolve();
                    }, function(error) {
                        reject(new Error('Failed to parse GLB file: ' + error.message));
                    });
                };
                
                reader.onerror = function() {
                    reject(new Error('Failed to read file'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // Process skeleton with renaming rules
        function processSkeleton(skeleton) {
            processingResults = {
                total: 0,
                renamed: [],
                unchanged: [],
                allMeshes: []
            };
            
            skeleton.traverse(function(child) {
                if (child.isMesh) {
                    processingResults.total++;
                    const originalName = child.name;
                    let newName = originalName;
                    
                    // Apply renaming rules
                    if (originalName.endsWith('.r.001')) {
                        newName = originalName.replace('.r.001', '.l');
                    } else if (originalName.endsWith('_right.001')) {
                        newName = originalName.replace('_right.001', '_left');
                    }
                    
                    // Update mesh name if changed
                    if (newName !== originalName) {
                        child.name = newName;
                        processingResults.renamed.push({
                            from: originalName,
                            to: newName
                        });
                        console.log(`Renamed: ${originalName} ‚Üí ${newName}`);
                    } else {
                        processingResults.unchanged.push(originalName);
                    }
                    
                    processingResults.allMeshes.push(child.name);
                }
            });
            
            // Update display
            updateResults();
            updateProgress(80);
        }

        // Update results display
        function updateResults() {
            // Summary
            const summary = document.getElementById('summary');
            summary.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>Total Meshes:</strong> ${processingResults.total}<br>
                    <span style="color: #4CAF50;">Renamed:</span> ${processingResults.renamed.length}<br>
                    <span style="color: #ffd93d;">Unchanged:</span> ${processingResults.unchanged.length}
                </div>
            `;
            
            // Renamed meshes
            const renamedList = document.getElementById('renamed-list');
            if (processingResults.renamed.length > 0) {
                renamedList.innerHTML = processingResults.renamed.map(({ from, to }) => 
                    `<div class="mesh-item renamed">${from} ‚Üí ${to}</div>`
                ).join('');
            } else {
                renamedList.innerHTML = '<div class="mesh-item unchanged">No meshes were renamed</div>';
            }
            
            // All meshes
            const allMeshes = document.getElementById('all-meshes');
            allMeshes.innerHTML = processingResults.allMeshes.sort().map(name => 
                `<div class="mesh-item">${name}</div>`
            ).join('');
        }

        // Download processed GLB
        function downloadProcessed() {
            if (!originalSkeleton) {
                updateStatus('No processed skeleton to download!');
                return;
            }
            
            updateStatus('Exporting processed GLB...');
            
            const exporter = new THREE.GLTFExporter();
            exporter.parse(originalSkeleton, function(gltf) {
                const output = JSON.stringify(gltf, null, 2);
                const blob = new Blob([output], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'processed-skeleton.glb';
                link.click();
                
                URL.revokeObjectURL(url);
                updateStatus('‚úÖ Processed GLB downloaded as processed-skeleton.glb');
            }, { binary: true });
        }

        // Center skeleton in view
        function centerSkeleton() {
            if (!originalSkeleton) return;
            
            const box = new THREE.Box3().setFromObject(originalSkeleton);
            const center = new THREE.Vector3();
            box.getCenter(center);
            originalSkeleton.position.sub(center);
            
            const size = new THREE.Vector3();
            box.getSize(size);
            const maxDim = Math.max(size.x, size.y, size.z);
            const distance = maxDim * 2;
            
            camera.position.set(distance, distance * 0.5, distance);
            controls.target.set(0, 0, 0);
            controls.update();
        }

        // Reset view
        function resetView() {
            centerSkeleton();
        }

        // Update progress bar
        function updateProgress(percent) {
            document.getElementById('progress-bar').style.width = percent + '%';
        }

        // Update status
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log('Status:', message);
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // Initialize when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
